<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Yaratish (TTS) - EvolvoAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-2xl mx-auto p-6 md:p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white">ðŸ”Š Audio Yaratish (TTS)</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Matnni kiriting va uni eshitish uchun ovoz yarating.</p>
            <p class="text-sm text-blue-600 dark:text-blue-400 mt-1">Powered by Gemini 2.5 Flash TTS</p>
        </div>

        <!-- Matn kiritish maydoni -->
        <div class="space-y-6">
            <div>
                <label for="text-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sintez qilinadigan matn</label>
                <textarea id="text-input" rows="6" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Matnni shu yerga kiriting...">Assalomu alaykum! Men EvolvoAI kompaniyasining sun'iy intellekt ovoz yordamchisiman.</textarea>
            </div>

            <!-- Ovoz tanlash -->
            <div>
                <label for="voice-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ovozni tanlang</label>
                <select id="voice-select" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <!-- Ovozlar ro'yxati JavaScript orqali to'ldiriladi -->
                </select>
            </div>

            <!-- API Key kiritish -->
            <div>
                <label for="api-key-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Gemini API Key
                    <span class="text-xs text-gray-500">(Xavfsiz, faqat brauzerda saqlanadi)</span>
                </label>
                <input 
                    type="password" 
                    id="api-key-input" 
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" 
                    placeholder="AIzaSy..."
                />
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    API key yo'q? 
                    <a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-600 hover:underline">Bu yerdan oling</a>
                </p>
            </div>

            <!-- Boshqaruv tugmalari va audio pleyer -->
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 flex-wrap">
                <button id="generate-btn" class="flex-grow sm:flex-grow-0 flex items-center justify-center gap-2 bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                    <span>Audio Yaratish</span>
                </button>
                <button id="download-btn" class="flex-grow sm:flex-grow-0 flex items-center justify-center gap-2 bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 dark:focus:ring-green-800 transition duration-300 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    <span>Yuklab Olish</span>
                </button>
                <div id="loader" class="loader hidden"></div>
                <audio id="audio-player" controls class="w-full sm:w-auto rounded-lg hidden"></audio>
            </div>
            <!-- Xatolik xabari -->
            <div id="error-message" class="hidden text-red-500 bg-red-100 dark:bg-red-900/30 p-3 rounded-lg text-center mt-4"></div>
            <!-- Muvaffaqiyat xabari -->
            <div id="success-message" class="hidden text-green-600 bg-green-100 dark:bg-green-900/30 p-3 rounded-lg text-center mt-4"></div>
        </div>

        <!-- EvolvoAI Footer -->
        <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center">
            <p class="text-sm text-gray-600 dark:text-gray-400">
                Â© 2025 <a href="/" class="text-blue-600 hover:underline">EvolvoAI</a> - AI-Powered IT Solutions
            </p>
        </div>
    </div>

    <script>
        const textInput = document.getElementById('text-input');
        const voiceSelect = document.getElementById('voice-select');
        const apiKeyInput = document.getElementById('api-key-input');
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const loader = document.getElementById('loader');
        const audioPlayer = document.getElementById('audio-player');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        
        let currentAudioUrl = null;

        // LocalStorage dan API key ni yuklash
        const savedApiKey = localStorage.getItem('gemini_api_key');
        if (savedApiKey) {
            apiKeyInput.value = savedApiKey;
        }

        // API key ni saqlash
        apiKeyInput.addEventListener('blur', () => {
            if (apiKeyInput.value.trim()) {
                localStorage.setItem('gemini_api_key', apiKeyInput.value.trim());
            }
        });

        // Mavjud ovozlar ro'yxati
        const voices = [
            { name: "Zephyr (Yorqin)", value: "Zephyr" },
            { name: "Puck (Xushchaqchaq)", value: "Puck" },
            { name: "Charon (Ma'lumot beruvchi)", value: "Charon" },
            { name: "Kore (Qat'iy)", value: "Kore" },
            { name: "Fenrir (Hayajonli)", value: "Fenrir" },
            { name: "Aoede (Yengil)", value: "Aoede" },
            { name: "Puck", value: "Puck" }
        ];

        // Ovoz tanlash menyusini to'ldirish
        voices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.value;
            option.textContent = voice.name;
            voiceSelect.appendChild(option);
        });

        // Base64 ni ArrayBuffer ga o'girish
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // PCM ma'lumotlarini WAV fayliga o'girish
        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = new Int16Array(pcmData);
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.byteLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.byteLength, true);

            const wavBlob = new Blob([header, pcm16], { type: 'audio/wav' });
            return wavBlob;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        // API chaqiruvi uchun funksiya
        const generateAudio = async () => {
            const text = textInput.value.trim();
            const voice = voiceSelect.value;
            const apiKey = apiKeyInput.value.trim();

            if (!text) {
                showError("Iltimos, sintez qilish uchun matn kiriting.");
                return;
            }

            if (!apiKey) {
                showError("Iltimos, Gemini API key kiriting.");
                return;
            }

            setLoading(true);
            hideMessages();
            audioPlayer.classList.add('hidden');
            downloadBtn.classList.add('hidden');

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{
                        parts: [{ text: text }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: voice }
                            }
                        }
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorMsg = `HTTP xatosi! Status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error?.message || errorMsg;
                    } catch (e) {
                        errorMsg = `${errorMsg} - ${response.statusText}`;
                    }
                    throw new Error(errorMsg);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    currentAudioUrl = audioUrl;
                    
                    audioPlayer.src = audioUrl;
                    audioPlayer.classList.remove('hidden');
                    downloadBtn.classList.remove('hidden');
                    audioPlayer.play();
                    
                    showSuccess("âœ… Audio muvaffaqiyatli yaratildi!");
                } else {
                    throw new Error("API dan audio ma'lumotlari olinmadi.");
                }

            } catch (err) {
                console.error('Audio yaratishda xatolik:', err);
                showError(`Xatolik yuz berdi: ${err.message}`);
            } finally {
                setLoading(false);
            }
        };
        
        const downloadAudio = () => {
            if (!currentAudioUrl) return;
            const link = document.createElement('a');
            link.href = currentAudioUrl;
            link.download = 'evolvoai_tts_audio.wav';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showSuccess("Audio yuklab olindi!");
        };

        function setLoading(isLoading) {
            if (isLoading) {
                loader.classList.remove('hidden');
                generateBtn.disabled = true;
                generateBtn.querySelector('span').textContent = 'Yaratilmoqda...';
            } else {
                loader.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.querySelector('span').textContent = 'Audio Yaratish';
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => errorMessage.classList.add('hidden'), 5000);
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.remove('hidden');
            setTimeout(() => successMessage.classList.add('hidden'), 3000);
        }

        function hideMessages() {
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
        }
        
        generateBtn.addEventListener('click', generateAudio);
        downloadBtn.addEventListener('click', downloadAudio);
    </script>
</body>
</html>
